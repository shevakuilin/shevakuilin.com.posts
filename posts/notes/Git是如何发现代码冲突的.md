# Git 是如何发现代码冲突的

地址：https://shevakuilin.com/git-conflict/

创建时间：2020-01-02

## 简介

从 Git 原理上解析， Git 是如何在代码合并时发现冲突的

## 引言

写这篇文章的起因源于~~今年初~~去年初的一次面试，当时正在印象笔试面试 macOS 工程师，面试官是他们 macOS & iOS 端的负责人，在考察 Git 的时候突然问了这么一个问题：

> Git 是如何发现冲突的，能从原理上进行说明吗？它在进行检测的时候，是对本地和远程全部进行匹配吗，如果不是怎么做的？

非常有意思的问题，所以写这篇文章来从 Git 的原理上分析，它究竟是如何发现并定位冲突的，从而反向推出面试官想要考察的知识点。

## Git 如何存储数据？

首先说一下 Git 是如何储存数据的，Git 作为一个内容寻址文件系统，本质上是一个**键值对数据库**（key-value data store）。每存储一份数据，都会返回一个 `40` 位的 Hash 值作为`键`，通过这个键，我们就能找到所存储的数据。其中 Hash 值的前 `2` 位作为目录，后 `38` 位为文件名。文件的内容就是键值对的`值` ，也就是 Git 存储的一系列数据。

<img src="https://github.com/shevakuilin/GhostImageGit/raw/master/git数据格式.png" width="300" height ="300" />

Git 中的文件有三种状态：

- 未暂存
- 已暂存
- 已提交

Git 会存储 `已暂存` 和 `已提交` 的文件。同时，当我们提交数据时，当前的`commit`的注释、作者信息等也会被一并保存下来。

Git 通过键值对的方式存储数据，Git 存储的对象有四种:

- 提交对象
- 标签对象
- 树对象
- 数据对象

### 提交对象

每次向 Git 仓库中提交文件时，Git 会生成一个**提交对象**，用以保存当前提交的信息（包括 commit、author、committer等）和指向**树对象**的索引。这个提交对象的保存方式也是以 Hash 值为文件名的文件。

### 标签对象

Git 中的标签主要分为两种，**轻量标签**（lightweight）与**附注标签**（annotated）。这里的标签对象主要指附注标签，因为轻量标签只是一个特定提交的引用，而附注标签却是存储在 Git 数据库中的一个完整对象。附注标签中包含打标签者的名字、电子邮件地址、日期时间以及标签信息，是可以被校验（如果你对这个感兴趣，可以去了解使用 GNU Privacy Guard （GPG）对附注标签进行签名与验证 ）。其保存形式与提交对象相同。

### 树对象

Git 在每次提交时，会将暂存区的所有数据保存起来，这时会产生一个 **树对象** ，记录了在提交前，处于暂存区中的每个文件的状态（这个记录并非将数据都拷贝到当前树对象的文件中，而是记录了暂存区中每个文件的数据对象的 **键** ）。在不包含附注标签的情况下，每个 Git 仓库中包含 n + 2 个对象，分别是 1 个提交对象、1 个 树对象和 n 个数据对象。而树对象主要就是记录这三个数据对象的索引值和目录结构。

### 数据对象

Git 使用**数据对象**来记录每一个文件的数据。比如将一个文件添加到暂存区（index）中，这时，在 `objects` 目录下就会产生一个数据对象。

Git 就是将所需要用到的数据转为这四种对象，并且以 Hash 值为文件名的文件的形式，保存在 `.git/objects` 中。

<img src="https://github.com/shevakuilin/GhostImageGit/raw/master/git对象.png" width="800" height ="400" />

## Git 如何检测文件改动并定位？

每当所储存的文件发生改动，其对应的 Hash 值就会产生变化，对比不同版本文件的 Hash 值，即可知道文件是否发生过改变。

## 参考

[Git从原理到解决冲突](https://blog.csdn.net/qq_35414779/article/details/82630079)

[Git存储数据的原理](https://juejin.im/entry/5b4ad83af265da0f926b759a)

[Git 基础 - 打标签](https://git-scm.com/book/zh/v2/Git-基础-打标签)

[用 diff 来检查改动](https://www.git-tower.com/learn/git/ebook/cn/command-line/advanced-topics/diffs)

[Git 是怎样生成 diff 的：Myers 算法](https://cjting.me/2017/05/13/how-git-generate-diff/)